// INTEGRATION: Add to store.ts: none (reads existing runs via useStore)
// INTEGRATION: Add to types.ts: none (types are local)
// INTEGRATION: Add to page.tsx: import VulnerabilityHeatmap, add view === "heatmap" case
// INTEGRATION: Add to sidebar.tsx: add nav item { view: "heatmap", icon: Grid3X3, label: "Heatmap" }

"use client";

import { useState, useMemo } from "react";
import { useStore } from "@/lib/store";
import type { AttackCategory, Severity, AttackResult } from "@/lib/types";
import { CATEGORY_LABELS } from "@/lib/types";
import { Card, CardContent, CardHeader, CardTitle } from "@/components/ui/card";
import { Badge } from "@/components/ui/badge";
import { ScrollArea } from "@/components/ui/scroll-area";
import {
  Grid3X3,
  ShieldAlert,
  X,
  TrendingUp,
} from "lucide-react";

// ---------------------------------------------------------------------------
// Constants
// ---------------------------------------------------------------------------

const CATEGORIES: AttackCategory[] = ["injection", "jailbreak", "extraction", "bypass"];
const SEVERITIES: Severity[] = ["critical", "high", "medium", "low"];

const SEVERITY_LABELS: Record<Severity, string> = {
  critical: "Critical",
  high: "High",
  medium: "Medium",
  low: "Low",
};

// ---------------------------------------------------------------------------
// Helpers
// ---------------------------------------------------------------------------

function getHeatColor(rate: number): string {
  // Green (0%) -> Yellow (~50%) -> Red (100%)
  if (rate <= 0) return "hsl(142, 71%, 25%)"; // dark green
  if (rate <= 0.25) return "hsl(100, 60%, 30%)"; // green-yellow
  if (rate <= 0.5) return "hsl(45, 80%, 40%)"; // yellow
  if (rate <= 0.75) return "hsl(20, 80%, 40%)"; // orange
  return "hsl(0, 72%, 40%)"; // red
}

function getTextColor(rate: number): string {
  return rate > 0.3 ? "white" : "hsl(0, 0%, 90%)";
}

// ---------------------------------------------------------------------------
// Component
// ---------------------------------------------------------------------------

export function VulnerabilityHeatmap() {
  const { runs, activeRunId } = useStore();

  const [selectedCell, setSelectedCell] = useState<{
    category: AttackCategory;
    severity: Severity;
  } | null>(null);

  const activeRun = runs.find((r) => r.id === activeRunId) || null;
  const results = activeRun?.results || [];

  // Build heatmap data
  const heatmapData = useMemo(() => {
    const data: Record<
      AttackCategory,
      Record<Severity, { total: number; breached: number; rate: number }>
    > = {} as typeof data;

    for (const cat of CATEGORIES) {
      data[cat] = {} as Record<Severity, { total: number; breached: number; rate: number }>;
      for (const sev of SEVERITIES) {
        const matching = results.filter((r) => r.category === cat && r.severity === sev);
        const breached = matching.filter((r) => r.success).length;
        data[cat][sev] = {
          total: matching.length,
          breached,
          rate: matching.length > 0 ? breached / matching.length : 0,
        };
      }
    }

    return data;
  }, [results]);

  // Overall vulnerability score
  const overallScore = useMemo(() => {
    if (results.length === 0) return 0;
    const breached = results.filter((r) => r.success).length;
    return Math.round((breached / results.length) * 100);
  }, [results]);

  // Filtered results for selected cell
  const filteredResults: AttackResult[] = useMemo(() => {
    if (!selectedCell) return [];
    return results.filter(
      (r) => r.category === selectedCell.category && r.severity === selectedCell.severity
    );
  }, [selectedCell, results]);

  const scoreColor =
    overallScore >= 60
      ? "text-redpincer"
      : overallScore >= 30
        ? "text-warning"
        : "text-success";

  return (
    <div className="flex flex-col gap-6 p-6">
      <div className="flex items-center gap-3">
        <Grid3X3 className="h-6 w-6 text-lobster" />
        <h2 className="text-2xl font-bold text-foreground">Vulnerability Heatmap</h2>
      </div>

      {results.length === 0 ? (
        <Card className="border-border bg-card">
          <CardContent className="flex flex-col items-center gap-3 py-12">
            <Grid3X3 className="h-12 w-12 text-muted-foreground" />
            <p className="text-muted-foreground">
              {activeRun
                ? "No results in this run yet. Wait for attacks to complete."
                : "Select an active run from the Results view to see the heatmap."}
            </p>
          </CardContent>
        </Card>
      ) : (
        <>
          {/* Overall Score */}
          <Card className="border-border bg-card">
            <CardContent className="flex items-center gap-6 pt-4">
              <div className="flex flex-col items-center">
                <TrendingUp className={`h-8 w-8 ${scoreColor}`} />
                <span className="text-xs text-muted-foreground mt-1">Vulnerability</span>
              </div>
              <div>
                <span className={`text-5xl font-bold ${scoreColor}`}>{overallScore}</span>
                <span className="text-2xl text-muted-foreground">/100</span>
              </div>
              <div className="ml-4">
                <p className="text-sm text-muted-foreground">
                  {results.filter((r) => r.success).length} of {results.length} payloads breached
                  {activeRun && (
                    <span className="ml-1 text-xs">
                      against <span className="text-foreground font-medium">{activeRun.targetName}</span>
                    </span>
                  )}
                </p>
              </div>
            </CardContent>
          </Card>

          {/* Heatmap Grid */}
          <Card className="border-border bg-card">
            <CardHeader className="pb-3">
              <CardTitle className="text-sm font-semibold uppercase tracking-wider text-muted-foreground">
                Category vs Severity Matrix
              </CardTitle>
            </CardHeader>
            <CardContent>
              <div className="overflow-x-auto">
                <table className="w-full border-collapse">
                  <thead>
                    <tr>
                      <th className="px-3 py-2 text-left text-xs font-semibold text-muted-foreground">
                        Severity / Category
                      </th>
                      {CATEGORIES.map((cat) => (
                        <th
                          key={cat}
                          className="px-3 py-2 text-center text-xs font-semibold text-muted-foreground"
                        >
                          {CATEGORY_LABELS[cat]}
                        </th>
                      ))}
                    </tr>
                  </thead>
                  <tbody>
                    {SEVERITIES.map((sev) => (
                      <tr key={sev}>
                        <td className="px-3 py-2 text-sm font-semibold text-foreground">
                          {SEVERITY_LABELS[sev]}
                        </td>
                        {CATEGORIES.map((cat) => {
                          const cell = heatmapData[cat]?.[sev];
                          if (!cell || cell.total === 0) {
                            return (
                              <td key={cat} className="px-2 py-2 text-center">
                                <div className="mx-auto flex h-16 w-full max-w-[120px] items-center justify-center rounded-lg border border-border/50 bg-muted/20">
                                  <span className="text-xs text-muted-foreground">--</span>
                                </div>
                              </td>
                            );
                          }

                          const isSelected =
                            selectedCell?.category === cat && selectedCell?.severity === sev;

                          return (
                            <td key={cat} className="px-2 py-2 text-center">
                              <button
                                onClick={() =>
                                  setSelectedCell(
                                    isSelected ? null : { category: cat, severity: sev }
                                  )
                                }
                                className={`mx-auto flex h-16 w-full max-w-[120px] flex-col items-center justify-center rounded-lg transition-all hover:scale-105 ${
                                  isSelected ? "ring-2 ring-lobster ring-offset-2 ring-offset-background" : ""
                                }`}
                                style={{
                                  backgroundColor: getHeatColor(cell.rate),
                                  color: getTextColor(cell.rate),
                                }}
                              >
                                <span className="text-sm font-bold">
                                  {cell.breached}/{cell.total}
                                </span>
                                <span className="text-xs opacity-80">
                                  {Math.round(cell.rate * 100)}%
                                </span>
                              </button>
                            </td>
                          );
                        })}
                      </tr>
                    ))}
                  </tbody>
                </table>
              </div>

              {/* Legend */}
              <div className="mt-4 flex items-center gap-2 justify-center">
                <span className="text-xs text-muted-foreground">0%</span>
                <div className="flex h-3 w-48 overflow-hidden rounded">
                  <div className="flex-1" style={{ backgroundColor: "hsl(142, 71%, 25%)" }} />
                  <div className="flex-1" style={{ backgroundColor: "hsl(100, 60%, 30%)" }} />
                  <div className="flex-1" style={{ backgroundColor: "hsl(45, 80%, 40%)" }} />
                  <div className="flex-1" style={{ backgroundColor: "hsl(20, 80%, 40%)" }} />
                  <div className="flex-1" style={{ backgroundColor: "hsl(0, 72%, 40%)" }} />
                </div>
                <span className="text-xs text-muted-foreground">100%</span>
              </div>
            </CardContent>
          </Card>

          {/* Filtered Results Panel */}
          {selectedCell && (
            <Card className="border-lobster/30 bg-card">
              <CardHeader className="pb-3">
                <div className="flex items-center justify-between">
                  <CardTitle className="flex items-center gap-2 text-sm font-semibold uppercase tracking-wider text-lobster">
                    <ShieldAlert className="h-4 w-4" />
                    {CATEGORY_LABELS[selectedCell.category]} / {SEVERITY_LABELS[selectedCell.severity]}
                  </CardTitle>
                  <button
                    onClick={() => setSelectedCell(null)}
                    className="rounded p-1 text-muted-foreground hover:bg-muted hover:text-foreground"
                  >
                    <X className="h-4 w-4" />
                  </button>
                </div>
              </CardHeader>
              <CardContent>
                {filteredResults.length === 0 ? (
                  <p className="text-sm text-muted-foreground italic">No results for this combination.</p>
                ) : (
                  <ScrollArea className="max-h-[300px]">
                    <div className="flex flex-col gap-2">
                      {filteredResults.map((result) => (
                        <div
                          key={result.id}
                          className="rounded-lg border border-border p-3 text-sm"
                        >
                          <div className="flex items-center gap-2 mb-1">
                            <span className="font-medium text-foreground">
                              {result.payloadName}
                            </span>
                            <Badge
                              variant="outline"
                              className={
                                result.success
                                  ? "border-redpincer/50 text-redpincer"
                                  : "border-success/50 text-success"
                              }
                            >
                              {result.success ? "BREACHED" : "BLOCKED"}
                            </Badge>
                          </div>
                          <p className="text-xs text-muted-foreground line-clamp-2">
                            {result.analysis.reasoning}
                          </p>
                          <div className="mt-1 flex gap-2 text-xs">
                            <span className="text-muted-foreground">
                              Classification: {result.analysis.classification}
                            </span>
                            <span className="text-muted-foreground">
                              Score: {result.analysis.severityScore}/10
                            </span>
                          </div>
                        </div>
                      ))}
                    </div>
                  </ScrollArea>
                )}
              </CardContent>
            </Card>
          )}
        </>
      )}
    </div>
  );
}
